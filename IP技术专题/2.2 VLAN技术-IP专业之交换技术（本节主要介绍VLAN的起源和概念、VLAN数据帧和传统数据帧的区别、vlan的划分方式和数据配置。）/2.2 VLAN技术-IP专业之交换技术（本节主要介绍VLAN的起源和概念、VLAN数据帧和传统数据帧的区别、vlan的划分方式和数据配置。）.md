2/4/2021 6:53:13 PM 
##2.2 VLAN技术-IP专业之交换技术（本节主要介绍VLAN的起源和概念、VLAN数据帧和传统数据帧的区别、vlan的划分方式和数据配置。）
###2.2.1 VLAN
**Virtual Local Area**： 虚拟局域网
虚拟局域网，是将一个物理的，大的广播域在逻辑上划分成多个广播域的通信技术，VLAN实现方案在802.1Q协议草案。

* 限制广播域
* 增强局域网的安全性
* 提高网络的健壮性
* 不同VLAN间的用户若需要进行互访，必须经过三层路由转发。

###2.2.1 VLAN的核心思想 
解决广播泛滥的主导思想：将没有互访需求的主机隔离开

###2.2.2 VLAN数据帧与传统数据帧的区别
在传统以太网数据帧的基础上（源MAC地址长度和类型、长度子弹之间）增加了四个字节的**802.1Q Tag**。其中数据帧中VID（VLAN ID）字段用来标识该数据帧所属的VLAN,数据帧只能在所属的VLAN进行传输。
###2.2.3 VLAN的划分方式
* 基于端口
* 基于MAC地址
* 基于协议（IPX,IP）
###2.2.4 交换机的链路类型
VLAN信息可以跨越多台交换机被转递

###2.2.5 交换机的端口以三种分类
* Access接口：一般用于接用户计算机，一个Access端口只能属于一个VLAN。
* Trunk接口：一般用于交换机之间的互联的端口，trunk口可以属于多个VLAN，可以接受和发送多个VLAN的报文。
* Hybrid接口：可以用于交换机之间的连接，也可以用于接用户的计算机，Ｈybrid端口可以属于多个VLAN，可以接受和发送多个VLAN的报文。


###2.2.6 缺省VLAN(PVID)
**ACCESS端口**：
* 当交换机从用户主机收到不带VLAN Tag的报文，则加上端口的PVID；当收到带VLAN Tag的报文，则交换机不作处理丢弃。（**这是从交换机的其他口收到，不是我的，我不要**） 

* 当ACCESS端口向主机发送帧时，会剥离802.1Q的tag头部，发送普通的以太网帧给主机。（**当收到的VLAN ID 和当前的PVID相同的时候，就是发给我的，我需要处理一下，发给用户主机**）

**Trunk端口**（交换机之间的互联的端口）：  

* 当Trunk端口收到不带VLAN Tag的报文（**当从其他交换机端口收到不带VLAN Tag的报文，这个就默认是送达缺省路由的报文，我从这个端口接收到了，就需要发送给用户主机，所以要打上PVID**，我打标之后，其他口不一定要，只有下一个接口接收这个VID，才能正常工作），则打上端口的PVID,如果该帧包含802.1Q的报文头部，查看是否允许进入（缺省VID，所包含VID），如果可以则接收，否则丢弃。 
* 当发送帧时，比较该帧的VLAN ID与端口PVID，当不同时，且是允许通过的VLAN ID，则保留Tag，直接透明传输，当相同的时候，则去掉Tag，发送报文（为什么说，相同的时候就去掉呢，这说明是发给这个主机或者缺省VLAN的）。

**Hybrid端口**：

* 当接收到不带VLAN Tag的报文时，打上端口的PVID；当该帧包含802.1Q报文头部，查看是否允许进 入（PVID，所包含VID），如果可以则接收，否则丢弃。  
* 当发送报文时，当VLAN ID是该端口允许通过的VLAN ID，则发送该报文，并可以通过命令进行配置端口在发送该VLAN报文时候是否携带Tag。

**总结**

* 总的来说，在接受数据的时候，PVID的作用是为不带VLAN Tag的untag报文添加一个PVID 的tag；在发送报文的时候，将带有PVID Tag的报文的VLAN Tag剥离，从而发送一个不带VLAN Tag的untag报文。这也就是主机与交换机相连的时候采用Access端口，主机从属VLAN但是主机不感知VLAN的原因。  

* Trunk端口和Hybrid端口的最大区别是，Trunk端口在发送报文时候，只有当VLAN Tag=PVID的时候才会发送出不带Tag的报文；而Hybrid端口可以配置发送多个VLAN的报文，且不带VLAN Tag。  

* 值得一提的是，同一个交换机上Trunk和Hybrid是不允许并存的。

![PWE3的工作过程](../image/1.png)
