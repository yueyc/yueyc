2021/2/15 12:52:22 
##5.5 BGP协议概述-IP专业之IS-IS路由协议(主要介绍BGP协议基本概念 、BGP协议的基本工作机制和BGP对等体。)
为什么要学习BGP？
BGP应用广泛：城域网 承载网和IPRUN网络。
OSPF和ISIS只是实现了网络互通，但是我们的业务主要承载在VPN和BGP上。
BGP配置复杂
生命周期很长，未来在SDN中发挥重要作用。
###5.5.1 什么是BGP
####自治系统（AS）
由同一个技术管理机构管理、使用同一选路策略的一些路由器的集合。
####IGP与BGP
IGP：运行于AS内部（RIP、OSPF、ISIS）主要侧重于发现和计算路由。
EGP：运行于AS外部（BGP）主要侧重于路由传播和策略选择
####BGP特征
* 外部路由协议，用来在AS之间传递路由信息。
* 是一种增强的距离矢量路由协议。
 * 可靠的路由更新机制(TCP连接)
 * 丰富的Metric度量方法
 * 从设计上避免了环路的发生（内容：水平分割，外部：AS_Path）
* 为路由附带属性信息
* 支持CIDR（无类别域间选路）
* 丰富的路由过滤和路由策略

###5.5.2 BGP工作机制
* BGP可靠的路由更新
  * 传输协议：TCP，端口号179
  * 无需周期性更新
  * 路由更新：只发送增量路由
  * 周期性发送Keepalive报文校验TCP的连通性
###5.5.3 对等体（Peers = Neighbors）
* 两台路由器为交换BGP路由信息，建立TCP连接之后，他们之间的关系就是邻居关系。
* BGP邻居分为IBGP和EBGP。
 * EBGP的邻居处于不同的自治域，这些邻居一般直接连接，也可以采用loopback地址。
 * IBGP的邻居处理相同自治域，邻居之间可以不直连。
 * BGP的信息可以通过非BGP的拓扑进行传递，也就是说BGP可以通过多个非BGP路由连起来。

##5.6 BGP邻居建立过程-IP专业之IS-IS路由协议(BGP消息类型及应用、BGP报文结构和BGP邻居建立过程。)

###5.6.1 BGP消息类型

|报文名称|作用|发包时机|
|:----:|:----:|
|Open|协商BGP邻居的各类参数，建立邻居|建立TCP建立BGP连接时|
|UPdate|进行路由信息交换|建立连接后，由路由需要或者路由变化时|
|Notification|报告错误，终止邻居关系|当BGP发生错误|
|Keepalive|维持邻居关系|定时发送|
|Route-refresh|为保证网络稳定，触发更新路由的机制|当路由策略发生变化|

####BGP报文头
* Marker：16字节，用于标明BGP报文边界，所有比特都是1.
* Length：BGP消息总长度，包括头。
* Type：1字节，BGP消息的类型，其值是1到5，分别是open。update，notification，keepalive和route-refresh消息。其中，type1-4在RFC1771中定义，type5的消息则是在RFC2918定义。
 ![PWE3的工作过程](../image/1.png)  
####BGP建立消息（OPEN Message）
 * version BGP版本号。对于BGP-4来说，其值为4。
 * My autonomous system：本地AS号，根据两端的AS号可以确认是EBGP和IBGP。
 * Hold time：保持时间。建立对等体要协商Hold Time，选择两者比较小的。
 * BGP identity：BGP标识符，以IP地址形式标识，用来识别BGP路由器。一般是loopback地址。
####Update消息
 * UPdate消息在对等体之间交换路由信息，它既可以发布可达路由信息，也可以撤销不可达的路由。
  * 相同属性的路由才能在一个Update消息中更新出去
  * Update也用于撤销不可达路由（unrechable routes）
  * 如果路由稳定，将不会发送更新消息
  * 更新可以只是针对路由条目的属性更新
  * 更新包具备keepalive报文功效，使Holdtime定时器复位。
####BGP差错通告消息（notification）
  * 当检测到错误发生时，发送通告消息（Notification message）
  * 通告消息将会关闭BGP会话。
  * 可能出现的错误信息包括：验证失败，路由回路。
####Route-refresh
route-refresh消息用来要求对等体重新发送指定地质组的路由信息。

###5.6.3 BGP状态机
|状态名称|发什么包|功能|
|:---|:----:|
|Idle|尝试建立TCP连接|开始准备并监视远程Peer启动TCP连接，启动BGP要准备好足够资源|
|Connect|发TCP包|正在进行TCP连接，等待完成和认证都在TCP建立期间完成，若TCP连接不上则进入Active状态|
|Active|发TCP包|TCP连接建立不成功，反复尝试TCP连接|
|OPenSent|发OPen包|TCP连接已成功，开始发送Open包，Open包携带参数协商对等体的建立|
|OpenConfirm|发送Keepalive包|参数、能力特性协商成功，自己开始发送Keepalive包，等待对方Keepalive包|
|Established| 发UPdate包|已经收到对方Keepalive包，双方能力特性一致，开始使用Update通告路由信息|

* 注：
  *  **两个路由器的BGP邻居关系完全建立后，他们的邻居关系维持在Established状态**
  *  **BGP采用普通路由协议的动态发现邻居的方式是手工静态配置方式**
  
####BGP状态机

 ![PWE3的工作过程](../image/2.png) 
##5.7 BGP属性-IP专业之IS-IS路由协议(主要讲述BGP的各种属性和利用BGP属性进行路由控制。)
###5.7.1 路由属性的分类
BGP路由属性是一组参数，它对特定的路由进行了进一步的描述，使得BGP能够对路由进行过滤和选择。
所有的BGP路由属性都可以分为四类：

 * 公认必须遵循（Well-Known mandatory）：所有BGP路由器必须识别这种属性，并且必须存在于Update消息中，如果缺少这种属性，路由信息就会出错。
 * 公认可选（Well-Known discretionary）：所有BGP路由器必须认识这种属性，但是不必存在于Update消息中。
 * 可选过渡（Optional transitive）：在AS之间具有可传递传递属性，路由器可以不支持这个属性，但它仍然会接受带此属性的路由，并传给其他对等体。
 * 可选非过渡（OPtional non-transitive）：如果BGP路由不支持这个属性，可以忽略，也不通告给其他对等体。
###5.7.2 BGP的重要路由属性
* Origin属性
  * Origin属性定义路由信息的来源，标记一条路由是怎么成为BGP路由。有三种类型：
     * IGP：优先级最高，说明路由产生于本AS内。
     * EGP：优先级次之，说明路由通过EGP学到。
     * incomplete：优先级最低，"?"标识，路由的来源无法确定。
* AS路径（AS_PATH）属性
 * AS_PATH属性按一定次序记录了某条路由从本地到目的地址所要经过的所有AS编号，该属性为公认必遵。
 * 离本地AS最近的相邻AS号排在前面，其他AS叫按照顺序排列。
* NEXT_HOP（下一跳属性）
 * BGP的下一跳属性和IGP有所不同，不一定是邻居IP地址。
     * BGP发言人把**自己产生的路由**发给所有邻居时，将把路由信息的下一跳属性设置为**自己与对端连接的接口地址**；（见下图1，R1把学习到的路由给R2的时候，R1的next_Hop = 12.1.1.0）
      * 需要注意的是从IBGP邻居学习到的路由不会再发给我的BGP邻居。水平分割原则。
       
     * BGP发言人把收到的路由发送到EBGP对等体时，将把路由信息的下一跳属性设置为**自己与对端连接的接口地址**；（见下图2）
         
     * BGP发言人把从EBGP邻居得到的路由发送给IBGP邻居时，**并不改变该路由的下一跳属性。**如果配置了负载分担，路由被发送IBGP邻居时则会修改下一跳属性。（见下图3）
   * 总结：
      *  如果两个路由器之间的路由类型是IBGP，next_hop是不需要修改的（上一个路由器的loopback地址）；
      *  如果连个路由器之间的路由类型是EBGP，next_hop是需要修改的（本地与对端的loopback地址）。
      
![PWE3的工作过程](../image/3.png)

  **问： 为什么要如此设计？**  
   **答案：**减少路由数量。


* MED（Multi_Exit_DISC）
  * MED属性仅在相邻两个AS之间交换，收到此属性的AS一方不会再将其通告给任何第三方AS。
    * 相当于IGP使用的metrics，它用户判断流量进入AS时的最佳路由。
    * 当一个运行BGP的路由器通过不同的EBGP对等体得到目的地址相同但不同的路由时，在其他条件相同时，选择**MED较小者**作为最佳路由。 
* LOCAL_PREF(本地优先属性)
  * Local_Pref属性仅在IBGP对等体之间交换，不通告给其他AS。它表明BGP路由器的优先级。
  * Local_Pref属性用于判断流量离开AS时的最佳路由。当BGP路由器通过目的地址相同但下一跳不同的多条路由时，选择属性值高的路由。
* Community（团体属性）
  * 团体属性用来简化路由策略的应用和降低维护管理的难度，它是一组有相同特征的目的地址的集合，没有物理上的边界，与其所在的AS无关。 
   * Internet ：缺省情况下， 具有此属性的路由可以被通告所有的BGP对等体。
   * No_Export:不能被发布到本地AS之外。如果使用了联盟，则不能发布到联盟之外，里面可以。
   * No_Advertise：具有此属性的路由被接收后，不能被通告给其他的BGP对等体。
   * No_Export_SubConfed:不能被发布到本地AS外，也不能发布到联盟中其他子AS。
 

##5.8 BGP反射器-IP专业之IS-IS路由协议(引入BGP反射器的缘由、概念及反射原则、BGP反射器的防环机制)

###5.8.1 BGP反射器的引入
#### IBGP的水平分割原则
 * 从IBGP邻居收到的路由信息，并不会传递给其他的IBGP邻居，但可以传递给EBGP邻居，即IBGP的防环机制。这又导致了路由器要建立全连接，产生新的问题。
 * 若没有此机制，当三个路由器两两相连，并建立IBGP邻居时，那么此时其中一个路由器发送的更新将在三个路由器之间无限循环。
 * 为了解决要建立全连接的问题，引入了反射器和联盟的概念。
#### BGP反射器（Router Reflector，简称：RR）

由于BGP的防环机制，对等体之间要建立**全连接**（**逻辑上的全连接**）关系，当对等体数目很多时，对网络资源和CPU资源的消耗都很大。
 * 利用反射器可以解决这一问题，在一个AS内，其中一台路由器作为路由反射器（RR），其他路由器作为客户机（Client）与路由器反射器之间建立IBGP连接。
 * 这样反射器在客户机之间传递（反射）路由信息，而客户机之间不需要建立BGP连接。
 * 既不是反射器也不是客户机的BGP路由器被称之为非客户机。非客户机与路由器以及所有非客户机之间仍然必须建立全连接关系。  
 * 路由器反射器和他的客户机组成了一个Cluster（集群）。可以为一个集群的路由器反射器配置相同的Cluster，以避免路由循环。
  * 由于有些客户机之间已经建立了全连接，路由反射没必要，因此可以配置相关命令禁止反射。
  
 ![PWE3的工作过程](../image/4.png)
#### BGP反射器（Router Reflector，简称：RR）路由反射宣告原则
 * 原则1：如果路由是RR从**非客户机**的IBGP邻居学习到的，则只把它反射给客户机。
 * 原则2：如果由于是RR从**客户机**学习到的，他讲反射给除了发起该路由的客户机外的所有非客户机和客户机。
 * 原则3：如果路由是从**EBGP邻居**学习到的，将它反射到所有客户机和非客户机。
#### 路由反射-防环机制
 路由反射器的防环机制
  * Originator_ID属性
   * 可选非过渡，用于集群内的防环；
   * 由路由反射器产生，携带了本地AS内该路由发送者的Router ID。
   * 几个路由反射器自己组成一个环，可组成反射环，有了这个就避免了这个问题。
  * Cluster_List属性
   * 可选非过渡，用于集群间防环
   * 用于集群间的防环
   * 由每个路由反射器产生，记录反射路由经过的集群。 
   * 几个集群自己组成一个环，可组成反射环，有了这个就避免了这个问题。
#### 自治域联盟
 * 联盟就是将小的自治域组成一个大的自治域，自治域内采用IBGP，外部采用EBGP，也可有效减少网络的逻辑全连接数目，但是由于这个会改变网络的拓扑结构，所以用得比较少。
 

**总结：**

 * 联盟和路由反射器都是在IBGP环境中未解决全连接问题而提出的。
 * 当自治系统内网络很大的时候，建立IBGP全连接网开销很大，可以采用路由反射器。
 * RR路由反射器的一个好处就是配置方便，都是在反射器上进行，客户机不需要自己是客户机。

##5.9 BGP路径选择-IP专业之IS-IS路由协议(主要介绍BGP通告原则、BGP路由来源和BGP选路规则。)
###5.9.1 BGP路由通告原则
 * 原则1：BGP只通告在本地BGP路由表中是最优（Best，路由条目前有**">"**标识的路由）且有效（valid，路由条目前有"*"标识）的路由。
 * 原则2：BGP Speaker从EBGP获得的路由会向它所有BGP对等体宣告（EBGP和IBGP）。
 * 原则3：BGP SPeaker从IBGP获得的路由不会通过给他的IBGP邻居。
 * 原则4：BGP Speaker从IBGP获得的路由是否要通告给EBGP对等体要依据IGP和BGP同步情况来决定。
   * 同步是指IBGP和IGP（ISIS或者OSPF等，）之间的同步，其目的是为了避免出现误导外部AS路由器的现象发生。
   * 例如：如果一个AS中有非BGP路由器提供转发服务，经该AS转发的IP报文将可能因为目的地址不可达而被丢弃。如图11所示，Router E通过BGP从Router D可以学到Router A的一条路由8.0.0.0/8，于是将到这个目的地址的报文转发给Router D，Router D查询路由表，发现下一跳是Router B。由于Router D从IGP学到了到RouterB的路由，**所以通过路由迭代，Router D将报文转发给Router C。但Router C并不知道去8.0.0.0/8** 的路由，于是将报文丢弃。
   
    ![PWE3的工作过程](../image/5.png)
###5.9.2 BGP路由来源
 * 把IGP（eg：OSPF）发现的路由信息通过network命令注入到一个BGP路由表中。
 * 通过import-route命令把IGP路由或者静态路由注入到一个BGP路由表中。
 * 路由聚合
  * 自动聚合 auto-summary 
  * 手动聚合 aggregate （优先级比较高） 
##5.9.3 BGP选路规则
* 路由不可达，则忽略。
* 选择协议首选值prefVal最高的路由
* 选择本地优先级local_pref最高的路由
* 选择本地生成的路由
* 选择AS路径最短的路由
* 比较Origin属性，IGP，EGP，Incomplete路由。
* 选择MED值最低的路由。
* .......
